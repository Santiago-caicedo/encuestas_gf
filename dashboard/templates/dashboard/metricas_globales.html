{% extends 'dashboard/base_dashboard.html' %}

{% block content %}
<div class="space-y-6">

    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="flex items-center gap-4">
            <div class="p-3 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl text-white shadow-lg">
                <i class="fas fa-chart-line text-2xl"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-slate-800">Métricas Globales</h1>
                <p class="text-sm text-slate-500">Vista consolidada de todas las empresas del sistema</p>
            </div>
        </div>
        <div class="flex items-center gap-2 text-sm text-slate-500">
            <i class="fas fa-clock"></i>
            <span>Última actualización: {{ fecha_reporte|date:"d/m/Y H:i" }}</span>
        </div>
    </div>

    <!-- KPIs Principales -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Total Empresas -->
        <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Empresas Activas</p>
                    <p class="text-3xl font-bold text-slate-800 mt-1">{{ total_empresas }}</p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-building text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Total Respuestas -->
        <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Total Respuestas</p>
                    <p class="text-3xl font-bold text-slate-800 mt-1">{{ total_respuestas|floatformat:0 }}</p>
                </div>
                <div class="w-12 h-12 bg-emerald-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-file-alt text-emerald-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Respuestas Este Mes -->
        <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Este Mes</p>
                    <p class="text-3xl font-bold text-slate-800 mt-1">{{ respuestas_mes_actual }}</p>
                    <div class="flex items-center gap-1 mt-1">
                        {% if variacion_mensual >= 0 %}
                            <span class="text-xs font-semibold text-emerald-600">
                                <i class="fas fa-arrow-up"></i> {{ variacion_mensual }}%
                            </span>
                        {% else %}
                            <span class="text-xs font-semibold text-red-600">
                                <i class="fas fa-arrow-down"></i> {{ variacion_mensual }}%
                            </span>
                        {% endif %}
                        <span class="text-xs text-slate-400">vs mes anterior</span>
                    </div>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-calendar-alt text-purple-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Promedio por Empresa -->
        <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Promedio / Empresa</p>
                    <p class="text-3xl font-bold text-slate-800 mt-1">{{ promedio_por_empresa }}</p>
                    <p class="text-xs text-slate-400 mt-1">respuestas promedio</p>
                </div>
                <div class="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-chart-bar text-amber-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos Fila 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Tendencia Mensual -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-slate-800">Tendencia de Respuestas</h3>
                <span class="text-xs text-slate-400">Últimos 12 meses</span>
            </div>
            <div class="h-64">
                <canvas id="chartTendencia"></canvas>
            </div>
        </div>

        <!-- Top Empresas -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-slate-800">Top 10 Empresas</h3>
                <span class="text-xs text-slate-400">Por cantidad de respuestas</span>
            </div>
            <div class="h-64">
                <canvas id="chartTopEmpresas"></canvas>
            </div>
        </div>
    </div>

    <!-- Gráficos Fila 2 -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Distribución Tipo Tercero -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-slate-800">Tipo de Tercero</h3>
                <span class="text-xs text-slate-400">Distribución global</span>
            </div>
            <div class="h-48 flex items-center justify-center">
                <canvas id="chartTipoTercero"></canvas>
            </div>
        </div>

        <!-- Distribución por Aliado -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-slate-800">Empresas por Aliado</h3>
                <span class="text-xs text-slate-400">GFR vs Legal Shield</span>
            </div>
            <div class="h-48 flex items-center justify-center">
                <canvas id="chartAliado"></canvas>
            </div>
        </div>

        <!-- KPIs de Conocimiento -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-slate-800">Índice de Conocimiento</h3>
                <span class="text-xs text-slate-400">% que conoce el sistema</span>
            </div>
            <div class="space-y-4">
                {% if total_sagrilaft > 0 %}
                <div>
                    <div class="flex items-center justify-between text-sm mb-1">
                        <span class="font-medium text-slate-700">SAGRILAFT</span>
                        <span class="font-bold text-blue-600">{{ pct_conoce_sagrilaft }}%</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: {{ pct_conoce_sagrilaft }}%"></div>
                    </div>
                    <p class="text-xs text-slate-400 mt-1">{{ conocen_sagrilaft }} de {{ total_sagrilaft }} respuestas</p>
                </div>
                {% endif %}

                {% if total_sarlaft > 0 %}
                <div>
                    <div class="flex items-center justify-between text-sm mb-1">
                        <span class="font-medium text-slate-700">SARLAFT</span>
                        <span class="font-bold text-cyan-600">{{ pct_conoce_sarlaft }}%</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-2.5">
                        <div class="bg-cyan-600 h-2.5 rounded-full transition-all duration-500" style="width: {{ pct_conoce_sarlaft }}%"></div>
                    </div>
                    <p class="text-xs text-slate-400 mt-1">{{ conocen_sarlaft }} de {{ total_sarlaft }} respuestas</p>
                </div>
                {% endif %}

                {% if total_ptee > 0 %}
                <div>
                    <div class="flex items-center justify-between text-sm mb-1">
                        <span class="font-medium text-slate-700">PTEE</span>
                        <span class="font-bold text-purple-600">{{ pct_conoce_ptee }}%</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-2.5">
                        <div class="bg-purple-600 h-2.5 rounded-full transition-all duration-500" style="width: {{ pct_conoce_ptee }}%"></div>
                    </div>
                    <p class="text-xs text-slate-400 mt-1">{{ conocen_ptee }} de {{ total_ptee }} respuestas</p>
                </div>
                {% endif %}

                {% if total_sagrilaft == 0 and total_sarlaft == 0 and total_ptee == 0 %}
                <div class="text-center text-slate-400 py-8">
                    <i class="fas fa-chart-pie text-3xl mb-2"></i>
                    <p class="text-sm">Sin datos disponibles</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Tablas -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Actividad Reciente -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-4 border-b border-slate-100 flex items-center justify-between">
                <h3 class="font-bold text-slate-800">Actividad Reciente</h3>
                <span class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full font-semibold">
                    <i class="fas fa-circle text-[6px] mr-1 animate-pulse"></i> En vivo
                </span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-slate-50 text-slate-500 text-xs uppercase">
                        <tr>
                            <th class="px-4 py-3 text-left">Empresa</th>
                            <th class="px-4 py-3 text-left">Tipo</th>
                            <th class="px-4 py-3 text-left">Fecha</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {% for r in ultimas_respuestas %}
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                                    <span class="font-medium text-slate-700 truncate max-w-[150px]">{{ r.empresa.nombre }}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-0.5 rounded text-xs font-medium
                                    {% if r.tipo_tercero == 'CLIENTE' %}bg-blue-100 text-blue-700
                                    {% elif r.tipo_tercero == 'PROVEEDOR' %}bg-amber-100 text-amber-700
                                    {% elif r.tipo_tercero == 'EMPLEADO' %}bg-green-100 text-green-700
                                    {% else %}bg-slate-100 text-slate-600{% endif %}">
                                    {{ r.tipo_tercero }}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-slate-500 text-xs">
                                {{ r.fecha_registro|date:"d/m/Y H:i" }}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="px-4 py-8 text-center text-slate-400">
                                No hay actividad reciente
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Empresas Sin Actividad -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-4 border-b border-slate-100 flex items-center justify-between">
                <h3 class="font-bold text-slate-800">Empresas Sin Actividad</h3>
                <span class="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-full font-semibold">
                    <i class="fas fa-exclamation-triangle mr-1"></i> Últimos 30 días
                </span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-slate-50 text-slate-500 text-xs uppercase">
                        <tr>
                            <th class="px-4 py-3 text-left">Empresa</th>
                            <th class="px-4 py-3 text-center">Total Histórico</th>
                            <th class="px-4 py-3 text-right">Acción</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {% for e in empresas_sin_actividad %}
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-2 h-2 rounded-full bg-amber-500"></div>
                                    <span class="font-medium text-slate-700 truncate max-w-[150px]">{{ e.nombre }}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="font-semibold text-slate-600">{{ e.total_respuestas }}</span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <a href="{% url 'ver_metricas' e.id %}" class="text-blue-600 hover:text-blue-800 text-xs font-medium">
                                    Ver <i class="fas fa-arrow-right ml-1"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="px-4 py-8 text-center text-slate-400">
                                <i class="fas fa-check-circle text-emerald-500 text-2xl mb-2"></i>
                                <p>Todas las empresas tienen actividad reciente</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Colores consistentes
    const colores = {
        primario: 'rgba(59, 130, 246, 0.8)',
        secundario: 'rgba(16, 185, 129, 0.8)',
        terciario: 'rgba(139, 92, 246, 0.8)',
        cuaternario: 'rgba(245, 158, 11, 0.8)',
        fondo: 'rgba(59, 130, 246, 0.1)',
    };

    // Gráfico de Tendencia Mensual
    new Chart(document.getElementById('chartTendencia'), {
        type: 'line',
        data: {
            labels: {{ tendencia_labels|safe }},
            datasets: [{
                label: 'Respuestas',
                data: {{ tendencia_data|safe }},
                borderColor: colores.primario,
                backgroundColor: colores.fondo,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });

    // Gráfico Top Empresas
    new Chart(document.getElementById('chartTopEmpresas'), {
        type: 'bar',
        data: {
            labels: {{ top_empresas_labels|safe }},
            datasets: [{
                label: 'Respuestas',
                data: {{ top_empresas_data|safe }},
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(6, 182, 212, 0.8)',
                    'rgba(236, 72, 153, 0.8)',
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(168, 85, 247, 0.8)',
                    'rgba(251, 146, 60, 0.8)',
                ],
                borderRadius: 6,
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' }
                },
                y: {
                    grid: { display: false }
                }
            }
        }
    });

    // Gráfico Tipo Tercero
    new Chart(document.getElementById('chartTipoTercero'), {
        type: 'doughnut',
        data: {
            labels: {{ tipo_labels|safe }},
            datasets: [{
                data: {{ tipo_data|safe }},
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                ],
                borderWidth: 0,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { boxWidth: 12, padding: 15, font: { size: 11 } }
                }
            },
            cutout: '60%',
        }
    });

    // Gráfico Aliado
    new Chart(document.getElementById('chartAliado'), {
        type: 'pie',
        data: {
            labels: {{ aliado_labels|safe }},
            datasets: [{
                data: {{ aliado_data|safe }},
                backgroundColor: [
                    'rgba(15, 23, 42, 0.85)',
                    'rgba(59, 130, 246, 0.8)',
                ],
                borderWidth: 0,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { boxWidth: 12, padding: 15, font: { size: 11 } }
                }
            }
        }
    });
</script>
{% endblock %}
